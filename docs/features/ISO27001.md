# ISO 27001:2022 Compliance Module

The ISO 27001:2022 Compliance Module provides comprehensive support for Information Security Management System (ISMS) assessments based on the ISO/IEC 27001:2022 standard.

## Overview

ISO 27001:2022 is the international standard for information security management. This module implements:

- **93 Annex A Controls** organized in 4 themes
- **6-Step Assessment Wizard** for guided compliance evaluation
- **Statement of Applicability (SoA)** management
- **Gap Analysis** with prioritized remediation planning
- **Cross-Framework Mapping** to BSI IT-Grundschutz, NIS2, and NIST CSF
- **PDF Report Generation** for compliance documentation

## Control Themes

ISO 27001:2022 Annex A contains 93 controls organized into 4 themes:

| Theme | ID | Controls | Description |
|-------|-----|----------|-------------|
| Organizational | A.5 | 37 | Policies, roles, responsibilities, asset management |
| People | A.6 | 8 | Screening, awareness, remote working |
| Physical | A.7 | 14 | Perimeters, equipment, storage media |
| Technological | A.8 | 34 | Access control, cryptography, security operations |

## Assessment Workflow

### Step 1: Scope Definition

Define the certification scope including:
- Scope description (what the ISMS covers)
- Systems in scope (applications, databases, infrastructure)
- Locations (offices, data centers, remote locations)
- Processes (business processes covered by the ISMS)
- Risk appetite (low/medium/high)

### Step 2: Statement of Applicability (SoA)

For each of the 93 controls, determine:
- **Applicability**: Applicable, Not Applicable, or Excluded
- **Justification**: Reason for the applicability decision

### Step 3: Control Assessment

For applicable controls, evaluate:
- **Compliance Status**: Compliant, Partial, Gap, Not Evaluated
- **Implementation Level**: 0-100%
- **Evidence**: Documentation supporting the assessment
- **Implementation Notes**: Additional context

### Step 4: Gap Analysis

Review identified gaps:
- Gap description
- Remediation plan
- Remediation owner
- Due date
- Priority (Critical, High, Medium, Low)

### Step 5: Cross-Framework Mapping

View how ISO 27001 controls relate to:
- BSI IT-Grundschutz bausteins
- NIS2 Directive measures
- NIST Cybersecurity Framework

### Step 6: Report Generation

Generate compliance reports:
- Executive summary with overall score
- Theme-by-theme breakdown
- Gap analysis with remediation roadmap
- Cross-framework coverage analysis

## Scoring Formula

Compliance scores are calculated using:

```
score = (compliant + 0.5 * partial) / applicable * 100
```

Where:
- `compliant` = Controls with "Compliant" status
- `partial` = Controls with "Partial" status
- `applicable` = Total applicable controls

## API Endpoints

### Reference Data

```
GET  /api/v1/iso27001/themes         # Get all themes with control counts
GET  /api/v1/iso27001/controls       # List controls (with pagination/filtering)
GET  /api/v1/iso27001/controls/{id}  # Get specific control
```

### Dashboard

```
GET  /api/v1/iso27001/dashboard      # Dashboard statistics
```

### Assessment CRUD

```
POST   /api/v1/iso27001/assessments           # Create assessment
GET    /api/v1/iso27001/assessments           # List assessments
GET    /api/v1/iso27001/assessments/{id}      # Get assessment
DELETE /api/v1/iso27001/assessments/{id}      # Delete assessment
```

### Wizard Steps

```
PUT  /api/v1/iso27001/assessments/{id}/scope         # Update scope (Step 1)
GET  /api/v1/iso27001/assessments/{id}/wizard-state  # Get wizard state
```

### Statement of Applicability

```
GET  /api/v1/iso27001/assessments/{id}/soa             # Get SoA entries
PUT  /api/v1/iso27001/assessments/{id}/soa/{control}   # Update single entry
PUT  /api/v1/iso27001/assessments/{id}/soa             # Bulk update entries
```

### Analysis & Reports

```
GET  /api/v1/iso27001/assessments/{id}/overview  # Detailed overview
GET  /api/v1/iso27001/assessments/{id}/gaps      # Gap analysis
GET  /api/v1/iso27001/assessments/{id}/mapping   # Cross-framework mapping
GET  /api/v1/iso27001/assessments/{id}/report    # Generate report (JSON/PDF)
POST /api/v1/iso27001/assessments/{id}/complete  # Mark as complete
```

## Database Schema

### Tables

1. **iso27001_controls** - Reference data (93 controls)
   - Global table, not tenant-scoped
   - Pre-seeded with control definitions
   - Includes cross-framework references

2. **iso27001_assessments** - Assessment records
   - Tenant-scoped
   - Contains scope definition and scores
   - Tracks assessment workflow status

3. **iso27001_soa_entries** - Statement of Applicability
   - Links assessments to controls
   - Contains applicability decisions and compliance evaluations
   - Stores gap details and remediation plans

## Setup

### 1. Run Database Migration

```bash
cd apps/api
alembic upgrade head
```

### 2. Seed Control Data

```bash
python -m src.db.seed_iso27001
```

### 3. Verify Installation

```bash
# Check themes (should return 4)
curl http://localhost:8000/api/v1/iso27001/themes

# Check controls (should return 93)
curl http://localhost:8000/api/v1/iso27001/controls
```

## PDF Reports

PDF reports require the `reportlab` library:

```bash
pip install reportlab
```

Generate reports via API:

```bash
# JSON format
GET /api/v1/iso27001/assessments/{id}/report?format=json

# PDF format (downloads file)
GET /api/v1/iso27001/assessments/{id}/report?format=pdf
```

## Cross-Framework Mapping

Each control includes mappings to related controls in other frameworks:

```json
{
  "control_id": "A.5.1",
  "cross_references": {
    "bsi_grundschutz": ["ISMS.1.A1", "ISMS.1.A2"],
    "nis2": ["NIS2-GOV-01"],
    "nist_csf": ["ID.GV-1", "ID.GV-2"]
  }
}
```

This enables organizations to:
- Identify coverage overlap between frameworks
- Reduce duplicate compliance efforts
- Map existing BSI/NIS2 controls to ISO 27001

## Multi-Language Support

Control titles and descriptions are available in:
- English (title_en, description_en)
- German (title_de, description_de)
- Spanish (title_es, description_es)

## Best Practices

1. **Start with Scope**: Clearly define what's in and out of scope
2. **Document Justifications**: Always justify exclusions
3. **Prioritize Gaps**: Use the 1-4 priority scale for remediation planning
4. **Track Evidence**: Link controls to evidence artifacts
5. **Regular Reviews**: Re-assess annually or after major changes
