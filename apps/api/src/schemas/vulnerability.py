"""
Vulnerability Management Schemas.

Pydantic schemas for API validation and serialization.
"""
from datetime import datetime
from typing import Optional, List, Dict, Any
from pydantic import BaseModel, Field
from enum import Enum


# Enums
class VulnerabilitySeverity(str, Enum):
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"


class VulnerabilityStatus(str, Enum):
    OPEN = "open"
    IN_PROGRESS = "in_progress"
    REMEDIATED = "remediated"
    ACCEPTED = "accepted"
    FALSE_POSITIVE = "false_positive"
    MITIGATED = "mitigated"


class ScanStatus(str, Enum):
    PENDING = "pending"
    RUNNING = "running"
    COMPLETED = "completed"
    FAILED = "failed"
    CANCELLED = "cancelled"


class ScanType(str, Enum):
    NETWORK = "network"
    WEB_APP = "web_app"
    CONTAINER = "container"
    CODE = "code"
    CLOUD = "cloud"
    COMPLIANCE = "compliance"


class AssetType(str, Enum):
    SERVER = "server"
    WORKSTATION = "workstation"
    NETWORK_DEVICE = "network_device"
    DATABASE = "database"
    WEB_APPLICATION = "web_application"
    CONTAINER = "container"
    CLOUD_RESOURCE = "cloud_resource"
    IOT_DEVICE = "iot_device"
    MOBILE_DEVICE = "mobile_device"


class AssetCriticality(str, Enum):
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"


# Asset Schemas
class AssetBase(BaseModel):
    name: str = Field(..., min_length=1, max_length=255)
    asset_type: AssetType
    hostname: Optional[str] = None
    ip_address: Optional[str] = None
    mac_address: Optional[str] = None
    fqdn: Optional[str] = None
    criticality: AssetCriticality = AssetCriticality.MEDIUM
    environment: Optional[str] = None
    owner: Optional[str] = None
    department: Optional[str] = None
    operating_system: Optional[str] = None
    os_version: Optional[str] = None
    services: List[str] = []
    open_ports: List[int] = []
    location: Optional[str] = None
    cloud_provider: Optional[str] = None
    cloud_region: Optional[str] = None
    tags: List[str] = []
    custom_attributes: Dict[str, Any] = {}


class AssetCreate(AssetBase):
    pass


class AssetUpdate(BaseModel):
    name: Optional[str] = None
    asset_type: Optional[AssetType] = None
    hostname: Optional[str] = None
    ip_address: Optional[str] = None
    mac_address: Optional[str] = None
    fqdn: Optional[str] = None
    criticality: Optional[AssetCriticality] = None
    environment: Optional[str] = None
    owner: Optional[str] = None
    department: Optional[str] = None
    operating_system: Optional[str] = None
    os_version: Optional[str] = None
    services: Optional[List[str]] = None
    open_ports: Optional[List[int]] = None
    location: Optional[str] = None
    cloud_provider: Optional[str] = None
    cloud_region: Optional[str] = None
    tags: Optional[List[str]] = None
    custom_attributes: Optional[Dict[str, Any]] = None
    is_active: Optional[bool] = None


class AssetResponse(AssetBase):
    id: str
    is_active: bool
    last_seen: Optional[datetime] = None
    created_at: datetime
    updated_at: Optional[datetime] = None
    vulnerability_count: int = 0

    class Config:
        from_attributes = True


class AssetListResponse(BaseModel):
    assets: List[AssetResponse]
    total: int
    page: int
    page_size: int


# CVE Schemas
class CVEBase(BaseModel):
    cve_id: str = Field(..., pattern=r"^CVE-\d{4}-\d{4,}$")
    description: Optional[str] = None
    cvss_version: Optional[str] = None
    cvss_score: Optional[float] = Field(None, ge=0.0, le=10.0)
    cvss_vector: Optional[str] = None
    severity: Optional[VulnerabilitySeverity] = None
    epss_score: Optional[float] = Field(None, ge=0.0, le=1.0)
    epss_percentile: Optional[float] = Field(None, ge=0.0, le=100.0)
    is_kev: bool = False
    references: List[str] = []
    cwe_ids: List[str] = []
    affected_cpe: List[str] = []


class CVECreate(CVEBase):
    pass


class CVEResponse(CVEBase):
    id: str
    kev_date_added: Optional[datetime] = None
    kev_due_date: Optional[datetime] = None
    published_date: Optional[datetime] = None
    modified_date: Optional[datetime] = None
    created_at: datetime

    class Config:
        from_attributes = True


# Vulnerability Schemas
class VulnerabilityBase(BaseModel):
    title: str = Field(..., min_length=1, max_length=512)
    description: Optional[str] = None
    severity: VulnerabilitySeverity
    cvss_score: Optional[float] = Field(None, ge=0.0, le=10.0)
    cvss_vector: Optional[str] = None
    vulnerability_type: Optional[str] = None
    affected_component: Optional[str] = None
    affected_version: Optional[str] = None
    remediation_steps: Optional[str] = None
    tags: List[str] = []


class VulnerabilityCreate(VulnerabilityBase):
    asset_ids: List[str] = []
    cve_ids: List[str] = []
    detected_by: Optional[str] = None
    proof: Optional[str] = None


class VulnerabilityUpdate(BaseModel):
    title: Optional[str] = None
    description: Optional[str] = None
    severity: Optional[VulnerabilitySeverity] = None
    status: Optional[VulnerabilityStatus] = None
    cvss_score: Optional[float] = Field(None, ge=0.0, le=10.0)
    cvss_vector: Optional[str] = None
    vulnerability_type: Optional[str] = None
    affected_component: Optional[str] = None
    affected_version: Optional[str] = None
    remediation_steps: Optional[str] = None
    remediation_deadline: Optional[datetime] = None
    assigned_to: Optional[str] = None
    tags: Optional[List[str]] = None


class VulnerabilityStatusUpdate(BaseModel):
    status: VulnerabilityStatus
    comment: Optional[str] = None
    # For risk acceptance
    risk_acceptance_reason: Optional[str] = None
    risk_acceptance_expiry: Optional[datetime] = None


class VulnerabilityResponse(VulnerabilityBase):
    id: str
    status: VulnerabilityStatus
    risk_score: float
    detected_by: Optional[str] = None
    detection_method: Optional[str] = None
    first_detected: Optional[datetime] = None
    last_detected: Optional[datetime] = None
    proof: Optional[str] = None
    remediation_deadline: Optional[datetime] = None
    remediated_at: Optional[datetime] = None
    risk_accepted_at: Optional[datetime] = None
    risk_acceptance_reason: Optional[str] = None
    scan_id: Optional[str] = None
    assigned_to: Optional[str] = None
    created_at: datetime
    updated_at: Optional[datetime] = None
    affected_assets: List[AssetResponse] = []
    cves: List[CVEResponse] = []

    class Config:
        from_attributes = True


class VulnerabilityListResponse(BaseModel):
    vulnerabilities: List[VulnerabilityResponse]
    total: int
    page: int
    page_size: int


class VulnerabilityCommentCreate(BaseModel):
    content: str = Field(..., min_length=1)
    comment_type: str = "note"


class VulnerabilityCommentResponse(BaseModel):
    id: str
    vulnerability_id: str
    content: str
    comment_type: str
    created_at: datetime
    created_by: Optional[str] = None

    class Config:
        from_attributes = True


# Scan Schemas
class ScanBase(BaseModel):
    name: str = Field(..., min_length=1, max_length=255)
    scan_type: ScanType
    scanner: str = Field(..., min_length=1, max_length=100)
    target_scope: Optional[str] = None
    scan_config: Dict[str, Any] = {}


class ScanCreate(ScanBase):
    target_asset_id: Optional[str] = None
    scheduled_at: Optional[datetime] = None


class ScanResponse(ScanBase):
    id: str
    target_asset_id: Optional[str] = None
    status: ScanStatus
    scheduled_at: Optional[datetime] = None
    started_at: Optional[datetime] = None
    completed_at: Optional[datetime] = None
    total_findings: int
    critical_count: int
    high_count: int
    medium_count: int
    low_count: int
    info_count: int
    error_message: Optional[str] = None
    created_at: datetime
    created_by: Optional[str] = None

    class Config:
        from_attributes = True


class ScanListResponse(BaseModel):
    scans: List[ScanResponse]
    total: int
    page: int
    page_size: int


# Schedule Schemas
class ScanScheduleCreate(BaseModel):
    name: str = Field(..., min_length=1, max_length=255)
    scan_type: ScanType
    scanner: str
    target_scope: str
    cron_expression: str
    timezone: str = "UTC"
    scan_config: Dict[str, Any] = {}
    notification_emails: List[str] = []


class ScanScheduleResponse(BaseModel):
    id: str
    name: str
    scan_type: ScanType
    scanner: str
    target_scope: str
    cron_expression: str
    timezone: str
    is_active: bool
    last_run: Optional[datetime] = None
    next_run: Optional[datetime] = None
    scan_config: Dict[str, Any]
    notification_emails: List[str]
    created_at: datetime

    class Config:
        from_attributes = True


# Statistics Schemas
class VulnerabilityStats(BaseModel):
    total_vulnerabilities: int
    open_vulnerabilities: int
    in_progress_vulnerabilities: int
    remediated_vulnerabilities: int

    by_severity: Dict[str, int]
    by_status: Dict[str, int]

    total_assets: int
    assets_with_vulnerabilities: int

    total_scans: int
    scans_last_30_days: int

    mean_time_to_remediate_days: Optional[float] = None
    overdue_vulnerabilities: int

    top_vulnerable_assets: List[Dict[str, Any]] = []
    recent_vulnerabilities: List[VulnerabilityResponse] = []


# Import Schemas
class VulnerabilityImport(BaseModel):
    """Schema for importing vulnerabilities from scanner reports."""
    scanner: str
    scan_date: Optional[datetime] = None
    findings: List[Dict[str, Any]]


class ImportResult(BaseModel):
    imported: int
    updated: int
    skipped: int
    errors: List[str] = []
