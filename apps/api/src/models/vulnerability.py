"""
Vulnerability Management Models.

Database models for Vulnerabilities, Scans, Assets, and Remediation tracking.
"""
from datetime import datetime
from typing import Optional, List
from uuid import uuid4
from sqlalchemy import (
    Column, String, DateTime, Text, Integer, Float, Boolean,
    ForeignKey, Table, Enum as SQLEnum, JSON
)
from sqlalchemy.orm import relationship, Mapped, mapped_column
from sqlalchemy.dialects.postgresql import ARRAY
import enum

from src.db.database import Base


class VulnerabilitySeverity(str, enum.Enum):
    """CVSS-based severity classification."""
    CRITICAL = "critical"  # 9.0-10.0
    HIGH = "high"          # 7.0-8.9
    MEDIUM = "medium"      # 4.0-6.9
    LOW = "low"            # 0.1-3.9
    INFO = "info"          # Informational


class VulnerabilityStatus(str, enum.Enum):
    """Vulnerability lifecycle status."""
    OPEN = "open"
    IN_PROGRESS = "in_progress"
    REMEDIATED = "remediated"
    ACCEPTED = "accepted"  # Risk accepted
    FALSE_POSITIVE = "false_positive"
    MITIGATED = "mitigated"  # Compensating control in place


class ScanStatus(str, enum.Enum):
    """Scan execution status."""
    PENDING = "pending"
    RUNNING = "running"
    COMPLETED = "completed"
    FAILED = "failed"
    CANCELLED = "cancelled"


class ScanType(str, enum.Enum):
    """Type of vulnerability scan."""
    NETWORK = "network"
    WEB_APP = "web_app"
    CONTAINER = "container"
    CODE = "code"
    CLOUD = "cloud"
    COMPLIANCE = "compliance"


class AssetType(str, enum.Enum):
    """Type of asset."""
    SERVER = "server"
    WORKSTATION = "workstation"
    NETWORK_DEVICE = "network_device"
    DATABASE = "database"
    WEB_APPLICATION = "web_application"
    CONTAINER = "container"
    CLOUD_RESOURCE = "cloud_resource"
    IOT_DEVICE = "iot_device"
    MOBILE_DEVICE = "mobile_device"


class AssetCriticality(str, enum.Enum):
    """Asset business criticality."""
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"


# Association tables
vulnerability_asset_association = Table(
    'vulnerability_asset_association',
    Base.metadata,
    Column('vulnerability_id', String(36), ForeignKey('vulnerabilities.id'), primary_key=True),
    Column('asset_id', String(36), ForeignKey('assets.id'), primary_key=True)
)

vulnerability_cve_association = Table(
    'vulnerability_cve_association',
    Base.metadata,
    Column('vulnerability_id', String(36), ForeignKey('vulnerabilities.id'), primary_key=True),
    Column('cve_id', String(36), ForeignKey('cve_entries.id'), primary_key=True)
)


class Asset(Base):
    """Asset model for vulnerability tracking."""
    __tablename__ = "assets"

    id: Mapped[str] = mapped_column(String(36), primary_key=True, default=lambda: str(uuid4()))
    name: Mapped[str] = mapped_column(String(255), nullable=False, index=True)
    asset_type = mapped_column(SQLEnum(AssetType), nullable=False, index=True)

    # Identification
    hostname: Mapped[Optional[str]] = mapped_column(String(255), nullable=True)
    ip_address: Mapped[Optional[str]] = mapped_column(String(45), nullable=True, index=True)
    mac_address: Mapped[Optional[str]] = mapped_column(String(17), nullable=True)
    fqdn: Mapped[Optional[str]] = mapped_column(String(512), nullable=True)

    # Classification
    criticality = mapped_column(SQLEnum(AssetCriticality), default=AssetCriticality.MEDIUM)
    environment: Mapped[Optional[str]] = mapped_column(String(50), nullable=True)  # prod, staging, dev
    owner: Mapped[Optional[str]] = mapped_column(String(255), nullable=True)
    department: Mapped[Optional[str]] = mapped_column(String(255), nullable=True)

    # Technical details
    operating_system: Mapped[Optional[str]] = mapped_column(String(255), nullable=True)
    os_version: Mapped[Optional[str]] = mapped_column(String(100), nullable=True)
    services = mapped_column(ARRAY(String), default=[])
    open_ports = mapped_column(ARRAY(Integer), default=[])

    # Location
    location: Mapped[Optional[str]] = mapped_column(String(255), nullable=True)
    cloud_provider: Mapped[Optional[str]] = mapped_column(String(50), nullable=True)
    cloud_region: Mapped[Optional[str]] = mapped_column(String(50), nullable=True)

    # Metadata
    tags = mapped_column(ARRAY(String), default=[])
    custom_attributes = mapped_column(JSON, default={})

    # Status
    is_active: Mapped[bool] = mapped_column(Boolean, default=True)
    last_seen: Mapped[Optional[datetime]] = mapped_column(DateTime, nullable=True)

    # Timestamps
    created_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow)
    updated_at: Mapped[Optional[datetime]] = mapped_column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    # Relationships
    vulnerabilities = relationship(
        "Vulnerability",
        secondary=vulnerability_asset_association,
        back_populates="affected_assets"
    )
    scans = relationship("VulnerabilityScan", back_populates="target_asset")


class CVEEntry(Base):
    """CVE (Common Vulnerabilities and Exposures) reference."""
    __tablename__ = "cve_entries"

    id: Mapped[str] = mapped_column(String(36), primary_key=True, default=lambda: str(uuid4()))
    cve_id: Mapped[str] = mapped_column(String(20), nullable=False, unique=True, index=True)  # CVE-YYYY-NNNNN

    # Description
    description: Mapped[Optional[str]] = mapped_column(Text, nullable=True)

    # CVSS Scoring
    cvss_version: Mapped[Optional[str]] = mapped_column(String(10), nullable=True)  # 2.0, 3.0, 3.1
    cvss_score: Mapped[Optional[float]] = mapped_column(Float, nullable=True)
    cvss_vector: Mapped[Optional[str]] = mapped_column(String(255), nullable=True)
    severity = mapped_column(SQLEnum(VulnerabilitySeverity), nullable=True)

    # EPSS (Exploit Prediction Scoring System)
    epss_score: Mapped[Optional[float]] = mapped_column(Float, nullable=True)
    epss_percentile: Mapped[Optional[float]] = mapped_column(Float, nullable=True)

    # KEV (Known Exploited Vulnerabilities)
    is_kev: Mapped[bool] = mapped_column(Boolean, default=False)
    kev_date_added: Mapped[Optional[datetime]] = mapped_column(DateTime, nullable=True)
    kev_due_date: Mapped[Optional[datetime]] = mapped_column(DateTime, nullable=True)

    # References
    references = mapped_column(JSON, default=[])  # List of URLs
    cwe_ids = mapped_column(ARRAY(String), default=[])  # CWE-XXX

    # Affected products (CPE)
    affected_cpe = mapped_column(ARRAY(String), default=[])

    # Dates
    published_date: Mapped[Optional[datetime]] = mapped_column(DateTime, nullable=True)
    modified_date: Mapped[Optional[datetime]] = mapped_column(DateTime, nullable=True)

    # Timestamps
    created_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow)
    updated_at: Mapped[Optional[datetime]] = mapped_column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    # Relationships
    vulnerabilities = relationship(
        "Vulnerability",
        secondary=vulnerability_cve_association,
        back_populates="cves"
    )


class Vulnerability(Base):
    """Vulnerability finding model."""
    __tablename__ = "vulnerabilities"

    id: Mapped[str] = mapped_column(String(36), primary_key=True, default=lambda: str(uuid4()))

    # Identification
    title: Mapped[str] = mapped_column(String(512), nullable=False, index=True)
    description: Mapped[Optional[str]] = mapped_column(Text, nullable=True)

    # Classification
    severity = mapped_column(SQLEnum(VulnerabilitySeverity), nullable=False, index=True)
    status = mapped_column(SQLEnum(VulnerabilityStatus), default=VulnerabilityStatus.OPEN, index=True)

    # Scoring
    cvss_score: Mapped[Optional[float]] = mapped_column(Float, nullable=True)
    cvss_vector: Mapped[Optional[str]] = mapped_column(String(255), nullable=True)
    risk_score: Mapped[float] = mapped_column(Float, default=0.0)  # Calculated based on asset criticality + CVSS

    # Technical details
    vulnerability_type: Mapped[Optional[str]] = mapped_column(String(100), nullable=True)
    affected_component: Mapped[Optional[str]] = mapped_column(String(255), nullable=True)
    affected_version: Mapped[Optional[str]] = mapped_column(String(100), nullable=True)

    # Detection
    detected_by: Mapped[Optional[str]] = mapped_column(String(100), nullable=True)  # Scanner name
    detection_method: Mapped[Optional[str]] = mapped_column(String(100), nullable=True)
    first_detected: Mapped[Optional[datetime]] = mapped_column(DateTime, nullable=True)
    last_detected: Mapped[Optional[datetime]] = mapped_column(DateTime, nullable=True)

    # Proof/Evidence
    proof: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    screenshot_url: Mapped[Optional[str]] = mapped_column(String(1024), nullable=True)

    # Remediation
    remediation_steps: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    remediation_deadline: Mapped[Optional[datetime]] = mapped_column(DateTime, nullable=True)
    remediated_at: Mapped[Optional[datetime]] = mapped_column(DateTime, nullable=True)
    remediated_by: Mapped[Optional[str]] = mapped_column(String(36), nullable=True)

    # Risk acceptance (if accepted)
    risk_accepted_by: Mapped[Optional[str]] = mapped_column(String(36), nullable=True)
    risk_accepted_at: Mapped[Optional[datetime]] = mapped_column(DateTime, nullable=True)
    risk_acceptance_reason: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    risk_acceptance_expiry: Mapped[Optional[datetime]] = mapped_column(DateTime, nullable=True)

    # Metadata
    tags = mapped_column(ARRAY(String), default=[])
    external_refs = mapped_column(JSON, default={})

    # Source
    scan_id: Mapped[Optional[str]] = mapped_column(String(36), ForeignKey("vulnerability_scans.id"), nullable=True)

    # Timestamps
    created_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow)
    updated_at: Mapped[Optional[datetime]] = mapped_column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    # User tracking
    created_by: Mapped[Optional[str]] = mapped_column(String(36), ForeignKey("users.id"), nullable=True)
    assigned_to: Mapped[Optional[str]] = mapped_column(String(36), ForeignKey("users.id"), nullable=True)

    # Relationships
    affected_assets = relationship(
        "Asset",
        secondary=vulnerability_asset_association,
        back_populates="vulnerabilities"
    )
    cves = relationship(
        "CVEEntry",
        secondary=vulnerability_cve_association,
        back_populates="vulnerabilities"
    )
    scan = relationship("VulnerabilityScan", back_populates="findings")
    comments = relationship("VulnerabilityComment", back_populates="vulnerability", cascade="all, delete-orphan")


class VulnerabilityComment(Base):
    """Comments/notes on vulnerabilities."""
    __tablename__ = "vulnerability_comments"

    id: Mapped[str] = mapped_column(String(36), primary_key=True, default=lambda: str(uuid4()))
    vulnerability_id: Mapped[str] = mapped_column(String(36), ForeignKey("vulnerabilities.id"), nullable=False)

    content: Mapped[str] = mapped_column(Text, nullable=False)
    comment_type: Mapped[str] = mapped_column(String(50), default="note")  # note, status_change, assignment

    # Timestamps
    created_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow)
    created_by: Mapped[Optional[str]] = mapped_column(String(36), ForeignKey("users.id"), nullable=True)

    # Relationships
    vulnerability = relationship("Vulnerability", back_populates="comments")


class VulnerabilityScan(Base):
    """Vulnerability scan execution."""
    __tablename__ = "vulnerability_scans"

    id: Mapped[str] = mapped_column(String(36), primary_key=True, default=lambda: str(uuid4()))
    name: Mapped[str] = mapped_column(String(255), nullable=False)

    # Configuration
    scan_type = mapped_column(SQLEnum(ScanType), nullable=False)
    scanner: Mapped[str] = mapped_column(String(100), nullable=False)  # nessus, qualys, openvas, etc.

    # Target
    target_asset_id: Mapped[Optional[str]] = mapped_column(String(36), ForeignKey("assets.id"), nullable=True)
    target_scope: Mapped[Optional[str]] = mapped_column(Text, nullable=True)  # IP ranges, URLs, etc.

    # Execution
    status = mapped_column(SQLEnum(ScanStatus), default=ScanStatus.PENDING, index=True)
    scheduled_at: Mapped[Optional[datetime]] = mapped_column(DateTime, nullable=True)
    started_at: Mapped[Optional[datetime]] = mapped_column(DateTime, nullable=True)
    completed_at: Mapped[Optional[datetime]] = mapped_column(DateTime, nullable=True)

    # Results summary
    total_findings: Mapped[int] = mapped_column(Integer, default=0)
    critical_count: Mapped[int] = mapped_column(Integer, default=0)
    high_count: Mapped[int] = mapped_column(Integer, default=0)
    medium_count: Mapped[int] = mapped_column(Integer, default=0)
    low_count: Mapped[int] = mapped_column(Integer, default=0)
    info_count: Mapped[int] = mapped_column(Integer, default=0)

    # Error handling
    error_message: Mapped[Optional[str]] = mapped_column(Text, nullable=True)

    # Configuration used
    scan_config = mapped_column(JSON, default={})

    # Timestamps
    created_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow)
    created_by: Mapped[Optional[str]] = mapped_column(String(36), ForeignKey("users.id"), nullable=True)

    # Relationships
    target_asset = relationship("Asset", back_populates="scans")
    findings = relationship("Vulnerability", back_populates="scan")


class ScanSchedule(Base):
    """Scheduled recurring scans."""
    __tablename__ = "scan_schedules"

    id: Mapped[str] = mapped_column(String(36), primary_key=True, default=lambda: str(uuid4()))
    name: Mapped[str] = mapped_column(String(255), nullable=False)

    # Schedule configuration
    scan_type = mapped_column(SQLEnum(ScanType), nullable=False)
    scanner: Mapped[str] = mapped_column(String(100), nullable=False)
    target_scope: Mapped[str] = mapped_column(Text, nullable=False)

    # Cron-like schedule
    cron_expression: Mapped[str] = mapped_column(String(100), nullable=False)  # e.g., "0 2 * * 0" (Sundays at 2am)
    timezone: Mapped[str] = mapped_column(String(50), default="UTC")

    # Status
    is_active: Mapped[bool] = mapped_column(Boolean, default=True)
    last_run: Mapped[Optional[datetime]] = mapped_column(DateTime, nullable=True)
    next_run: Mapped[Optional[datetime]] = mapped_column(DateTime, nullable=True)

    # Configuration
    scan_config = mapped_column(JSON, default={})
    notification_emails = mapped_column(ARRAY(String), default=[])

    # Timestamps
    created_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow)
    updated_at: Mapped[Optional[datetime]] = mapped_column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    created_by: Mapped[Optional[str]] = mapped_column(String(36), ForeignKey("users.id"), nullable=True)
